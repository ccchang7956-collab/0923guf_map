<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <title>å…‰å¾©ç½å®³åœ°åœ–</title>
    
    <!-- å…è¨±åœ¨iframeä¸­åµŒå…¥ -->
    <meta http-equiv="Content-Security-Policy" content="frame-ancestors *;">
    
    <!-- Open Graph å…ƒè³‡æ–™ï¼Œç”¨æ–¼åˆ†äº«é è¦½ -->
    <meta property="og:title" content="å…‰å¾©ç½å®³åœ°åœ–">
    <meta property="og:description" content="èŠ±è“®ç¸£å…‰å¾©é„‰ã€è¬æ¦®é„‰ã€é³³æ—é®ç½å®³æ‡‰æ€¥è¨­æ–½åœ°åœ–">
    <meta property="og:type" content="website">
    <meta property="og:image" content="https://via.placeholder.com/1200x630/3b82f6/ffffff?text=å…‰å¾©ç½å®³åœ°åœ–">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="å…‰å¾©ç½å®³åœ°åœ–">
    <meta name="twitter:description" content="èŠ±è“®ç¸£å…‰å¾©é„‰ã€è¬æ¦®é„‰ã€é³³æ—é®ç½å®³æ‡‰æ€¥è¨­æ–½åœ°åœ–">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* å„€è¡¨æ¿å¡ç‰‡é¸ä¸­ç‹€æ…‹ */
        .dashboard-card.selected {
            transform: scale(1.02);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        
        .dashboard-card.selected.toilets {
            border-color: #f97316;
            background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%);
        }
        
        .dashboard-card.selected.showers {
            border-color: #10b981;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        }
        
        .dashboard-card.selected.water {
            border-color: #06b6d4;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        }
        
        .dashboard-card.selected.medical {
            border-color: #dc2626;
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
        }
        
        .dashboard-card.selected .icon-container {
            transform: scale(1.1);
        }
        
        /* Hoveræ•ˆæœå¢å¼· */
        .dashboard-card:hover {
            transform: translateY(-2px);
        }
        
        .dashboard-card.selected:hover {
            transform: scale(1.02) translateY(-2px);
        }
        
        /* æ‰‹æ©Ÿç‰ˆå„ªåŒ– */
        @media (max-width: 768px) {
            .dashboard-card {
                padding: 1rem; /* æ¸›å°‘å…§é‚Šè· */
            }
            
            .dashboard-card h3 {
                font-size: 1rem; /* å¢å¤§æ¨™é¡Œå­—é«” */
            }
            
            .dashboard-card .text-3xl {
                font-size: 2.25rem; /* å¢å¤§æ•¸å­—å­—é«” */
            }
            
            .dashboard-card .text-xs {
                font-size: 0.75rem; /* å¢å¤§æç¤ºæ–‡å­— */
            }
            
            .dashboard-card .text-sm {
                font-size: 0.875rem; /* å¢å¤§å°å­—é«” */
            }
            
            .dashboard-card .rounded-full {
                padding: 0.75rem; /* ç¨å¾®å¢å¤§åœ–æ¨™å®¹å™¨ */
            }
            
            .dashboard-card .rounded-full i {
                font-size: 1.75rem; /* å¢å¤§åœ–æ¨™ */
            }
        }

        /* è¼‰å…¥å‹•ç•«æ¨£å¼ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 0.3s ease-in-out;
        }

        .loading-container {
            text-align: center;
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            max-width: 300px;
            width: 90%;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #e5e7eb;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem auto;
        }

        .loading-dots {
            display: inline-block;
            position: relative;
            width: 80px;
            height: 12px;
            margin: 1rem 0;
        }

        .loading-dots div {
            position: absolute;
            top: 0;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #3b82f6;
            animation: loading-dots 1.2s linear infinite;
        }

        .loading-dots div:nth-child(1) { left: 8px; animation-delay: 0s; }
        .loading-dots div:nth-child(2) { left: 32px; animation-delay: -0.4s; }
        .loading-dots div:nth-child(3) { left: 56px; animation-delay: -0.8s; }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes loading-dots {
            0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #06b6d4);
            border-radius: 2px;
            width: 0%;
            transition: width 0.3s ease-out;
        }

        .loading-text {
            color: #6b7280;
            font-size: 14px;
            margin-top: 1rem;
            font-weight: 500;
        }

        .loading-fade-out {
            opacity: 0;
            pointer-events: none;
        }

        /* è„ˆè¡å‹•ç•« */
        .pulse-animation {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* åœ°åœ–ç¯©é¸æŒ‰éˆ•æ¨£å¼ */
        .map-filter-control {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            min-width: 200px;
            max-width: 220px;
            transition: all 0.3s ease;
        }

        .map-filter-control.collapsed {
            min-width: auto;
            max-width: 140px;
        }

        .map-filter-header {
            font-weight: 600;
            font-size: 12px;
            color: #374151;
            padding: 8px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
            background: #f8fafc;
            margin: -8px -8px 8px -8px;
            border-radius: 8px 8px 0 0;
        }

        .map-filter-header:hover {
            background: #f1f5f9;
        }

        .map-filter-header .toggle-icon {
            transition: transform 0.3s ease;
            font-size: 10px;
            color: #6b7280;
        }

        .map-filter-control.collapsed .toggle-icon {
            transform: rotate(180deg);
        }

        .map-filter-buttons {
            padding: 8px;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .map-filter-control.collapsed .map-filter-buttons {
            max-height: 0;
            padding: 0 8px;
            opacity: 0;
        }

        .map-filter-button {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 6px 8px;
            margin: 2px 0;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 11px;
            font-weight: 500;
        }

        .map-filter-button:hover {
            background: #f9fafb;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .map-filter-button.active {
            background: #dbeafe;
            border-color: #3b82f6;
            color: #1d4ed8;
        }

        .map-filter-button .icon {
            margin-right: 6px;
            min-width: 14px;
            text-align: center;
        }

        .map-filter-button .count {
            margin-left: auto;
            background: #f3f4f6;
            color: #6b7280;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
        }

        .map-filter-button.active .count {
            background: #3b82f6;
            color: white;
        }

        /* ç¯©é¸æŒ‰éˆ•ç‰¹å®šé¡è‰² */
        .map-filter-button.toilets.active {
            background: #fed7aa;
            border-color: #f97316;
            color: #ea580c;
        }

        .map-filter-button.toilets.active .count {
            background: #f97316;
            color: white;
        }

        .map-filter-button.showers.active {
            background: #bbf7d0;
            border-color: #10b981;
            color: #059669;
        }

        .map-filter-button.showers.active .count {
            background: #10b981;
            color: white;
        }

        .map-filter-button.water.active {
            background: #bae6fd;
            border-color: #06b6d4;
            color: #0891b2;
        }

        .map-filter-button.water.active .count {
            background: #06b6d4;
            color: white;
        }

        .map-filter-button.medical.active {
            background: #fecaca;
            border-color: #dc2626;
            color: #dc2626;
        }

        .map-filter-button.medical.active .count {
            background: #dc2626;
            color: white;
        }

        /* æ‰‹æ©Ÿç‰ˆåœ°åœ–ç¯©é¸å™¨èª¿æ•´ */
        @media (max-width: 768px) {
            .map-filter-control {
                top: 10px;
                right: 10px;
                min-width: 140px;
                max-width: 160px;
            }

            .map-filter-control.collapsed {
                min-width: auto;
                max-width: 120px;
            }

            .map-filter-header {
                padding: 6px;
                font-size: 11px;
            }

            .map-filter-buttons {
                padding: 6px;
            }

            .map-filter-control.collapsed .map-filter-buttons {
                padding: 0 6px;
            }

            .map-filter-button {
                padding: 4px 6px;
                font-size: 10px;
                margin: 1px 0;
            }

            .map-filter-button .icon {
                margin-right: 3px;
                min-width: 10px;
                font-size: 10px;
            }

            .map-filter-button .count {
                padding: 1px 4px;
                font-size: 9px;
            }
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- è¼‰å…¥å‹•ç•«è¦†è“‹å±¤ -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <h3 class="text-xl font-semibold text-gray-800 mb-2">
                <i class="fas fa-database text-blue-600 mr-2"></i>
                è¼‰å…¥è³‡æ–™
            </h3>
            <div class="progress-bar">
                <div class="progress-bar-fill"></div>
            </div>
            <div class="loading-dots">
                <div></div>
                <div></div>
                <div></div>
            </div>
            <p id="loading-text" class="loading-text">æ­£åœ¨è¼‰å…¥è¨­æ–½è³‡æ–™...</p>
            <p class="text-xs text-gray-500 mt-2">
                <i class="fas fa-info-circle mr-1"></i>
                æ­£åœ¨å¾ Google Apps Script API ç²å–å³æ™‚è³‡æ–™
            </p>
        </div>
    </div>

    <div class="container mx-auto p-4">
        <!-- æ¨™é¡Œ -->
        <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">
            <i class="fas fa-map-marked-alt text-blue-600 mr-3"></i>
            å…‰å¾©ç½å®³åœ°åœ–
        </h1>
        
        <!-- å„€è¡¨æ¿ -->
        <div class="grid grid-cols-2 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div id="card-toilets" class="dashboard-card bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-all duration-300 cursor-pointer border-2 border-transparent" data-type="æµå‹•å»æ‰€">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-600">
                            <i class="fas fa-restroom mr-2"></i>
                            æµå‹•å»æ‰€
                        </h3>
                        <p id="toilet-count" class="text-3xl font-bold text-orange-500">0</p>
                        <p class="text-sm text-gray-500">
                            <i class="fas fa-calculator mr-1"></i>
                            ç¸½åº§æ•¸: <span id="toilet-total">0</span>
                        </p>
                    </div>
                    <div class="text-orange-500 bg-orange-100 p-3 rounded-full transition-all duration-300">
                        <i class="fas fa-restroom text-3xl"></i>
                    </div>
                </div>
                <div class="mt-3 text-center">
                    <span class="text-xs text-gray-400">é»æ“Šç¯©é¸ | å†é»æ“Šå–æ¶ˆ</span>
                </div>
            </div>
            
            <div id="card-showers" class="dashboard-card bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-all duration-300 cursor-pointer border-2 border-transparent" data-type="æ²æµ´ç«™">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-600">
                            <i class="fas fa-shower mr-2"></i>
                            æ²æµ´ç«™
                        </h3>
                        <p id="shower-count" class="text-3xl font-bold text-green-500">0</p>
                        <p class="text-sm text-gray-500">
                            <i class="fas fa-calculator mr-1"></i>
                            ç¸½é–“æ•¸: <span id="shower-total">0</span>
                        </p>
                    </div>
                    <div class="text-green-500 bg-green-100 p-3 rounded-full transition-all duration-300">
                        <i class="fas fa-shower text-3xl"></i>
                    </div>
                </div>
                <div class="mt-3 text-center">
                    <span class="text-xs text-gray-400">é»æ“Šç¯©é¸ | å†é»æ“Šå–æ¶ˆ</span>
                </div>
            </div>
            
            <div id="card-water" class="dashboard-card bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-all duration-300 cursor-pointer border-2 border-transparent" data-type="å–æ°´ç«™">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-600">
                            <i class="fas fa-tint mr-2"></i>
                            å–æ°´ç«™
                        </h3>
                        <p id="water-count" class="text-3xl font-bold text-cyan-500">0</p>
                        <p class="text-sm text-gray-500">
                            <i class="fas fa-calculator mr-1"></i>
                            ç¸½æ¡¶æ•¸: <span id="water-total">0</span>
                        </p>
                    </div>
                    <div class="text-cyan-500 bg-cyan-100 p-3 rounded-full transition-all duration-300">
                        <i class="fas fa-tint text-3xl"></i>
                    </div>
                </div>
                <div class="mt-3 text-center">
                    <span class="text-xs text-gray-400">é»æ“Šç¯©é¸ | å†é»æ“Šå–æ¶ˆ</span>
                </div>
            </div>
            
            <div id="card-medical" class="dashboard-card bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-all duration-300 cursor-pointer border-2 border-transparent" data-type="ç½å€é†«ç™‚ç«™">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-600">
                            <i class="fas fa-user-md mr-2"></i>
                            ç½å€é†«ç™‚ç«™
                        </h3>
                        <p id="medical-count" class="text-3xl font-bold text-red-600">0</p>
                        <p class="text-sm text-gray-500">
                            <i class="fas fa-calculator mr-1"></i>
                            ç¸½ç«™æ•¸: <span id="medical-total">0</span>
                        </p>
                    </div>
                    <div class="text-red-600 bg-red-100 p-3 rounded-full transition-all duration-300">
                        <i class="fas fa-user-md text-3xl"></i>
                    </div>
                </div>
                <div class="mt-3 text-center">
                    <span class="text-xs text-gray-400">é»æ“Šç¯©é¸ | å†é»æ“Šå–æ¶ˆ</span>
                </div>
            </div>
        </div>

        <!-- åœ°åœ–å®¹å™¨ -->
        <div class="bg-white rounded-lg shadow-md p-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">
                    <i class="fas fa-map-marker-alt text-blue-600 mr-2"></i>
                    è¨­æ–½ä½ç½®åœ–
                </h2>
                <div class="flex gap-2">
                    <button id="locate-user" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded transition-colors">
                        <i class="fas fa-location-arrow mr-1"></i>
                        å®šä½
                    </button>
                    <button id="zoom-in" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded transition-colors">
                        <i class="fas fa-search-plus mr-1"></i>
                        æ”¾å¤§
                    </button>
                    <button id="zoom-out" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded transition-colors">
                        <i class="fas fa-search-minus mr-1"></i>
                        ç¸®å°
                    </button>
                </div>
            </div>
            <div class="relative">
                <div id="map" class="w-full h-96 rounded-lg border-2 border-gray-200"></div>
                
                <!-- åœ°åœ–ç¯©é¸æ§åˆ¶é¢æ¿ -->
                <div id="map-filter-control" class="map-filter-control">
                    <div class="map-filter-header" onclick="toggleMapFilter()">
                        <div>
                            <i class="fas fa-filter mr-1"></i>
                            è¨­æ–½ç¯©é¸
                        </div>
                        <i class="fas fa-chevron-up toggle-icon"></i>
                    </div>
                    
                    <div class="map-filter-buttons">
                        <button id="map-filter-all" class="map-filter-button active" onclick="filterFacilitiesFromMap('all')">
                            <span class="icon"><i class="fas fa-th-large"></i></span>
                            <span>å…¨éƒ¨è¨­æ–½</span>
                            <span id="map-count-all" class="count">0</span>
                        </button>
                        
                        <button id="map-filter-toilets" class="map-filter-button toilets" onclick="filterFacilitiesFromMap('æµå‹•å»æ‰€')">
                            <span class="icon"><i class="fas fa-restroom"></i></span>
                            <span>æµå‹•å»æ‰€</span>
                            <span id="map-count-toilets" class="count">0</span>
                        </button>
                        
                        <button id="map-filter-showers" class="map-filter-button showers" onclick="filterFacilitiesFromMap('æ²æµ´ç«™')">
                            <span class="icon"><i class="fas fa-shower"></i></span>
                            <span>æ²æµ´ç«™</span>
                            <span id="map-count-showers" class="count">0</span>
                        </button>
                        
                        <button id="map-filter-water" class="map-filter-button water" onclick="filterFacilitiesFromMap('å–æ°´ç«™')">
                            <span class="icon"><i class="fas fa-tint"></i></span>
                            <span>å–æ°´ç«™</span>
                            <span id="map-count-water" class="count">0</span>
                        </button>
                        
                        <button id="map-filter-medical" class="map-filter-button medical" onclick="filterFacilitiesFromMap('ç½å€é†«ç™‚ç«™')">
                            <span class="icon"><i class="fas fa-user-md"></i></span>
                            <span>é†«ç™‚ç«™</span>
                            <span id="map-count-medical" class="count">0</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- æœç´¢åŠŸèƒ½ -->
        <div class="bg-white rounded-lg shadow-md p-4 mt-6">
            <h2 class="text-xl font-semibold mb-3">
                <i class="fas fa-search text-blue-600 mr-2"></i>
                æœç´¢è¨­æ–½
            </h2>
            <div class="flex gap-2">
                <div class="flex-1 relative">
                    <input 
                        type="text" 
                        id="search-input" 
                        placeholder="è¼¸å…¥è¨­æ–½åç¨±æˆ–åœ°å€é€²è¡Œæœç´¢..."
                        class="w-full px-4 py-2 pl-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                    <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                </div>
                <button id="clear-search" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                    <i class="fas fa-times mr-1"></i>
                    æ¸…é™¤
                </button>
            </div>
            <div id="search-results" class="mt-2 hidden">
                <div class="text-sm text-gray-600 mb-1">æœç´¢çµæœ:</div>
                <div id="search-results-list" class="space-y-1"></div>
            </div>
        </div>

        <!-- è©³ç´°è³‡æ–™è¡¨æ ¼ -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden mt-6">
            <div class="p-4 bg-gray-600 text-white flex justify-between items-center cursor-pointer" onclick="toggleTable()">
                <div class="flex items-center">
                    <i class="fas fa-table mr-2"></i>
                    <h2 class="text-xl font-semibold">è¨­æ–½è©³ç´°è³‡æ–™</h2>
                    <span class="ml-2 text-sm text-gray-300">(é»æ“Šå±•é–‹/æ”¶åˆ)</span>
                </div>
                <div class="flex items-center">
                    <span id="table-status" class="text-sm mr-2">å·²æ”¶åˆ</span>
                    <i id="toggle-icon" class="fas fa-chevron-down transform transition-transform duration-300"></i>
                </div>
            </div>
            
            <div id="table-controls" class="p-3 bg-gray-50 border-b hidden">
                <div class="flex items-center gap-4">
                    <label for="table-filter" class="text-sm font-medium text-gray-700">
                        <i class="fas fa-filter mr-1"></i>
                        ç¯©é¸é¡åˆ¥:
                    </label>
                    <select id="table-filter" class="px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="all">ğŸŒ å…¨éƒ¨é¡åˆ¥</option>
                        <option value="æµå‹•å»æ‰€">ğŸš½ æµå‹•å»æ‰€</option>
                        <option value="æ²æµ´ç«™">ğŸš¿ æ²æµ´ç«™</option>
                        <option value="å–æ°´ç«™">ğŸ’§ å–æ°´ç«™</option>
                        <option value="ç½å€é†«ç™‚ç«™">ğŸ¥ ç½å€é†«ç™‚ç«™</option>
                    </select>
                    <div class="ml-auto text-sm text-gray-600">
                        <i class="fas fa-list-ol mr-1"></i>
                        é¡¯ç¤ºç­†æ•¸: <span id="table-count">0</span>
                    </div>
                </div>
            </div>
            
            <div id="table-content" class="hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full table-auto">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-4 py-2 text-left w-16">
                                    <i class="fas fa-hashtag mr-1 text-gray-600"></i>
                                    ç·¨è™Ÿ
                                </th>
                                <th class="px-4 py-2 text-left">
                                    <i class="fas fa-building mr-1 text-gray-600"></i>
                                    åç¨±
                                </th>
                                <th class="px-4 py-2 text-left">
                                    <i class="fas fa-tags mr-1 text-gray-600"></i>
                                    é¡åˆ¥
                                </th>
                                <th class="px-4 py-2 text-left">
                                    <i class="fas fa-map-marker-alt mr-1 text-gray-600"></i>
                                    åœ°å€
                                </th>
                                <th class="px-4 py-2 text-left">
                                    <i class="fas fa-info-circle mr-1 text-gray-600"></i>
                                    å‚™è¨»
                                </th>
                            </tr>
                        </thead>
                        <tbody id="facilities-table">
                            <!-- å‹•æ…‹ç”Ÿæˆçš„è¡¨æ ¼å…§å®¹ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API é…ç½®
        const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbzPXvPiW3L9rgK0DVLrb6I9SXEceJSgxsXNSwyAP0hNO5LECOXX9G0YGRs65hr-y6De/exec';
        
        // å…¨å±€è®Šæ•¸
        let map;
        let allFacilities = [];
        let filteredFacilities = [];
        let currentFilter = 'all';
        let markersLayer;
        let userMarker;

        // è¨­æ–½é¡å‹é…ç½®
        const facilityConfig = {
            'æµå‹•å»æ‰€': { 
                color: '#f97316', 
                icon: 'fas fa-restroom',
                bgColor: '#fff7ed',
                borderColor: '#fed7aa'
            },
            'æ²æµ´ç«™': { 
                color: '#10b981', 
                icon: 'fas fa-shower',
                bgColor: '#f0fdf4',
                borderColor: '#bbf7d0'
            },
            'è‡ªä¾†æ°´å…¬å¸çš„å–æ°´ç«™': { 
                color: '#06b6d4', 
                icon: 'fas fa-tint',
                bgColor: '#f0f9ff',
                borderColor: '#bae6fd'
            },
            'å–æ°´ç«™': { 
                color: '#06b6d4', 
                icon: 'fas fa-tint',
                bgColor: '#f0f9ff',
                borderColor: '#bae6fd'
            },
            'ç½å€é†«ç™‚ç«™': { 
                color: '#dc2626', 
                icon: 'fas fa-user-md',
                bgColor: '#fef2f2',
                borderColor: '#fecaca'
            },
            'ç½é›£é†«ç™‚ç«™': { 
                color: '#dc2626', 
                icon: 'fas fa-user-md',
                bgColor: '#fef2f2',
                borderColor: '#fecaca'
            },
            'æœªåˆ†é¡': { 
                color: '#6b7280', 
                icon: 'fas fa-map-marker-alt',
                bgColor: '#f9fafb',
                borderColor: '#d1d5db'
            }
        };

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            setupEventListeners();
            initMapFilterState(); // åˆå§‹åŒ–åœ°åœ–ç¯©é¸é¢æ¿ç‹€æ…‹
            initTableState(); // åˆå§‹åŒ–è¡¨æ ¼ç‹€æ…‹
            loadFacilities();
        });

        // API èª¿ç”¨å‡½æ•¸
        async function callAPI(endpoint, params = {}) {
            try {
                const url = new URL(API_BASE_URL);
                url.searchParams.append('path', endpoint);
                
                Object.keys(params).forEach(key => {
                    if (params[key] !== null && params[key] !== undefined) {
                        url.searchParams.append(key, params[key]);
                    }
                });

                console.log('API è«‹æ±‚:', url.toString());
                
                const response = await fetch(url.toString());
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'API è«‹æ±‚å¤±æ•—');
                }
                
                return data;
            } catch (error) {
                console.error('API éŒ¯èª¤:', error);
                throw error;
            }
        }

        // è¼‰å…¥è¨­æ–½è³‡æ–™
        async function loadFacilities() {
            try {
                // é¡¯ç¤ºè¼‰å…¥å‹•ç•«
                showMainLoading(true);
                updateProgress(0);
                updateLoadingText('æ­£åœ¨é€£æ¥ API...');
                
                // æ­¥é©Ÿ1: é€£æ¥API (0-20%)
                await new Promise(resolve => setTimeout(resolve, 300));
                updateProgress(20);
                updateLoadingText('æ­£åœ¨ç²å–è¨­æ–½è³‡æ–™...');
                
                // æ­¥é©Ÿ2: ç²å–è³‡æ–™ (20-60%)
                const data = await callAPI('facilities', { limit: 100 });
                updateProgress(60);
                updateLoadingText('æ­£åœ¨è§£æè³‡æ–™...');
                
                // æ­¥é©Ÿ3: è§£æè³‡æ–™ (60-80%)
                await new Promise(resolve => setTimeout(resolve, 300));
                allFacilities = data.data || [];
                filteredFacilities = [...allFacilities];
                updateProgress(80);
                
                console.log(`æˆåŠŸè¼‰å…¥ ${allFacilities.length} å€‹è¨­æ–½`);
                updateLoadingText('æ­£åœ¨åˆå§‹åŒ–åœ°åœ–...');
                
                // æ­¥é©Ÿ4: åˆå§‹åŒ–ç•Œé¢ (80-95%)
                await new Promise(resolve => setTimeout(resolve, 200));
                updateDashboard();
                updateProgress(90);
                
                updateMap();
                updateProgress(95);
                
                updateTable();
                updateProgress(100);
                
                // æ­¥é©Ÿ5: å®Œæˆ (100%)
                updateLoadingText('è¼‰å…¥å®Œæˆï¼');
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // éš±è—è¼‰å…¥å‹•ç•«
                showMainLoading(false);
                
            } catch (error) {
                console.error('è¼‰å…¥è¨­æ–½å¤±æ•—:', error);
                updateProgress(0);
                updateLoadingText('è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡è©¦');
                await new Promise(resolve => setTimeout(resolve, 1000));
                showMainLoading(false);
                alert('è¼‰å…¥è¨­æ–½è³‡æ–™å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥æˆ–ç¨å¾Œå†è©¦');
            }
        }

        // ä¸»è¼‰å…¥å‹•ç•«æ§åˆ¶
        function showMainLoading(show) {
            const overlay = document.getElementById('loading-overlay');
            
            if (show) {
                overlay.classList.remove('loading-fade-out');
                overlay.style.display = 'flex';
            } else {
                overlay.classList.add('loading-fade-out');
                // å»¶é²éš±è—ï¼Œè®“æ·¡å‡ºå‹•ç•«å®Œæˆ
                setTimeout(() => {
                    overlay.style.display = 'none';
                }, 300);
            }
        }

        // æ›´æ–°è¼‰å…¥æ–‡å­—
        function updateLoadingText(text) {
            const loadingText = document.getElementById('loading-text');
            if (loadingText) {
                loadingText.textContent = text;
            }
        }

        // æ›´æ–°é€²åº¦æ¢
        function updateProgress(percentage) {
            const progressFill = document.querySelector('.progress-bar-fill');
            if (progressFill) {
                progressFill.style.width = percentage + '%';
            }
        }

        // è¡¨æ ¼è¼‰å…¥ç‹€æ…‹é¡¯ç¤º
        function showLoading(show) {
            const loadingHtml = `
                <div class="flex items-center justify-center py-8">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mr-3"></div>
                    <span class="text-gray-600">è¼‰å…¥ä¸­...</span>
                </div>
            `;
            
            if (show) {
                document.getElementById('facilities-table').innerHTML = loadingHtml;
            }
        }

        // åˆå§‹åŒ–åœ°åœ–
        function initMap() {
            // ä»¥å…‰å¾©é„‰ç‚ºä¸­å¿ƒ
            map = L.map('map').setView([23.6577, 121.4269], 12);
            
            // æ·»åŠ  OpenStreetMap åœ–å±¤
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);
            
            // å‰µå»ºæ¨™è¨˜åœ–å±¤
            markersLayer = L.layerGroup().addTo(map);
        }

        // æ›´æ–°å„€è¡¨æ¿
        function updateDashboard() {
            // ç¸½æ˜¯ä½¿ç”¨å…¨éƒ¨è¨­æ–½ä¾†è¨ˆç®—çµ±è¨ˆï¼ˆå„€è¡¨æ¿é¡¯ç¤ºå…¨éƒ¨æ•¸æ“šï¼‰
            const allStats = calculateStats(allFacilities);
            
            // æ›´æ–°å„é¡å‹è¨ˆæ•¸ï¼ˆé¡¯ç¤ºå…¨éƒ¨è¨­æ–½çš„çµ±è¨ˆï¼‰
            document.getElementById('toilet-count').textContent = allStats['æµå‹•å»æ‰€']?.count || 0;
            document.getElementById('toilet-total').textContent = allStats['æµå‹•å»æ‰€']?.total || 0;
            
            document.getElementById('shower-count').textContent = allStats['æ²æµ´ç«™']?.count || 0;
            document.getElementById('shower-total').textContent = allStats['æ²æµ´ç«™']?.total || 0;
            
            const allWaterCount = (allStats['å–æ°´ç«™']?.count || 0) + (allStats['è‡ªä¾†æ°´å…¬å¸çš„å–æ°´ç«™']?.count || 0);
            const allWaterTotal = (allStats['å–æ°´ç«™']?.total || 0) + (allStats['è‡ªä¾†æ°´å…¬å¸çš„å–æ°´ç«™']?.total || 0);
            document.getElementById('water-count').textContent = allWaterCount;
            document.getElementById('water-total').textContent = allWaterTotal;
            
            const allMedicalCount = (allStats['ç½å€é†«ç™‚ç«™']?.count || 0) + (allStats['ç½é›£é†«ç™‚ç«™']?.count || 0);
            const allMedicalTotal = (allStats['ç½å€é†«ç™‚ç«™']?.total || 0) + (allStats['ç½é›£é†«ç™‚ç«™']?.total || 0);
            document.getElementById('medical-count').textContent = allMedicalCount;
            document.getElementById('medical-total').textContent = allMedicalTotal;
            
            // æ›´æ–°åœ°åœ–ç¯©é¸æŒ‰éˆ•è¨ˆæ•¸ï¼ˆé¡¯ç¤ºå…¨éƒ¨è¨­æ–½çš„ç¸½æ•¸ï¼‰
            updateMapFilterCounts();
        }

        // æ›´æ–°åœ°åœ–ç¯©é¸æŒ‰éˆ•çš„è¨ˆæ•¸
        function updateMapFilterCounts() {
            // ä½¿ç”¨å…¨éƒ¨è¨­æ–½ä¾†è¨ˆç®—å„é¡å‹çš„ç¸½æ•¸
            const allStats = calculateStats(allFacilities);
            
            // è¨ˆç®—å„é¡å‹çš„ç¸½æ•¸
            const totalWaterCount = (allStats['å–æ°´ç«™']?.count || 0) + (allStats['è‡ªä¾†æ°´å…¬å¸çš„å–æ°´ç«™']?.count || 0);
            const totalMedicalCount = (allStats['ç½å€é†«ç™‚ç«™']?.count || 0) + (allStats['ç½é›£é†«ç™‚ç«™']?.count || 0);
            
            // æ›´æ–°åœ°åœ–ç¯©é¸æŒ‰éˆ•é¡¯ç¤ºç¸½æ•¸
            document.getElementById('map-count-all').textContent = allFacilities.length;
            document.getElementById('map-count-toilets').textContent = allStats['æµå‹•å»æ‰€']?.count || 0;
            document.getElementById('map-count-showers').textContent = allStats['æ²æµ´ç«™']?.count || 0;
            document.getElementById('map-count-water').textContent = totalWaterCount;
            document.getElementById('map-count-medical').textContent = totalMedicalCount;
        }

        // è¨ˆç®—çµ±è¨ˆè³‡æ–™
        function calculateStats(facilities) {
            const stats = {};
            
            facilities.forEach(facility => {
                const type = facility.type;
                if (!stats[type]) {
                    stats[type] = { count: 0, total: 0 };
                }
                
                stats[type].count++;
                
                // å¾å‚™è¨»ä¸­æå–æ•¸é‡
                const note = facility.note || '';
                const match = note.match(/(\d+)/);
                if (match) {
                    stats[type].total += parseInt(match[1]);
                } else {
                    stats[type].total += 1; // å¦‚æœæ²’æœ‰æ•¸é‡ï¼Œé»˜èªç‚º1
                }
            });
            
            return stats;
        }

        // æ›´æ–°åœ°åœ–
        function updateMap() {
            // æ¸…é™¤ç¾æœ‰æ¨™è¨˜
            markersLayer.clearLayers();
            
            if (filteredFacilities.length === 0) return;
            
            const bounds = [];
            
            filteredFacilities.forEach(facility => {
                const config = facilityConfig[facility.type] || facilityConfig['æœªåˆ†é¡'];
                
                // å‰µå»ºè‡ªå®šç¾©åœ–æ¨™
                const customIcon = L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="
                        background-color: ${config.color};
                        width: 20px;
                        height: 20px;
                        border-radius: 50%;
                        border: 3px solid white;
                        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    ">
                        <i class="${config.icon}" style="color: white; font-size: 10px;"></i>
                    </div>`,
                    iconSize: [26, 26],
                    iconAnchor: [13, 13]
                });
                
                const marker = L.marker([facility.lat, facility.lng], {
                    icon: customIcon
                }).bindPopup(`
                    <div class="p-3 min-w-[200px]">
                        <h3 class="font-bold text-lg mb-2" style="color: ${config.color};">
                            <i class="${config.icon} mr-2"></i>
                            ${facility.name}
                        </h3>
                        <div class="space-y-1 text-sm">
                            <p><strong>é¡å‹:</strong> ${facility.type}</p>
                            <p><strong>åœ°å€:</strong> ${facility.address || 'æœªæä¾›'}</p>
                            ${facility.note ? `<p><strong>å‚™è¨»:</strong> ${facility.note}</p>` : ''}
                            <p class="text-xs text-gray-500 mt-2">
                                <i class="fas fa-map-marker-alt mr-1"></i>
                                ${facility.lat.toFixed(6)}, ${facility.lng.toFixed(6)}
                            </p>
                        </div>
                        <div class="mt-3 pt-2 border-t">
                            <a href="https://www.google.com/maps/search/?api=1&query=${facility.lat},${facility.lng}" 
                               target="_blank" 
                               class="text-blue-600 hover:text-blue-800 text-sm">
                                <i class="fas fa-external-link-alt mr-1"></i>
                                åœ¨ Google åœ°åœ–ä¸­é–‹å•Ÿ
                            </a>
                        </div>
                    </div>
                `);
                
                markersLayer.addLayer(marker);
                bounds.push([facility.lat, facility.lng]);
            });
            
            // èª¿æ•´åœ°åœ–è¦–é‡ä»¥åŒ…å«æ‰€æœ‰æ¨™è¨˜
            if (bounds.length > 0) {
                map.fitBounds(bounds, { padding: [20, 20] });
            }
        }

        // æ›´æ–°è¡¨æ ¼
        function updateTable() {
            const tbody = document.getElementById('facilities-table');
            
            if (filteredFacilities.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-8 text-gray-500">
                            <i class="fas fa-inbox text-3xl mb-2"></i>
                            <p>æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„è¨­æ–½</p>
                        </td>
                    </tr>
                `;
                
                // æ›´æ–°é¡¯ç¤ºç­†æ•¸
                document.getElementById('table-count').textContent = '0';
                return;
            }
            
            tbody.innerHTML = filteredFacilities.map((facility, index) => {
                const config = facilityConfig[facility.type] || facilityConfig['æœªåˆ†é¡'];
                const serialNumber = index + 1; // æµæ°´ç·¨è™Ÿå¾1é–‹å§‹
                
                return `
                    <tr class="hover:bg-gray-50 cursor-pointer" onclick="focusOnFacility(${facility.lat}, ${facility.lng})">
                        <td class="px-4 py-3 text-center">
                            <span class="inline-flex items-center justify-center w-8 h-8 bg-blue-100 text-blue-800 text-sm font-medium rounded-full">
                                ${serialNumber}
                            </span>
                        </td>
                        <td class="px-4 py-3">
                            <div class="flex items-center">
                                <i class="${config.icon} mr-2" style="color: ${config.color};"></i>
                                <span class="font-medium">${facility.name}</span>
                            </div>
                        </td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 text-xs font-semibold rounded-full" 
                                  style="background-color: ${config.bgColor}; color: ${config.color}; border: 1px solid ${config.borderColor};">
                                ${facility.type}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-sm">
                            <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(facility.address || facility.lat + ',' + facility.lng)}" 
                               target="_blank" 
                               class="text-blue-600 hover:text-blue-800 hover:underline"
                               onclick="event.stopPropagation();">
                                ${facility.address || `${facility.lat.toFixed(4)}, ${facility.lng.toFixed(4)}`}
                            </a>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-600">
                            ${facility.note || '-'}
                        </td>
                    </tr>
                `;
            }).join('');
            
            // æ›´æ–°é¡¯ç¤ºç­†æ•¸
            document.getElementById('table-count').textContent = filteredFacilities.length;
        }

        // èšç„¦åˆ°ç‰¹å®šè¨­æ–½
        function focusOnFacility(lat, lng) {
            map.setView([lat, lng], 16);
        }

        // ç¯©é¸è¨­æ–½
        function filterFacilities(type) {
            // æª¢æŸ¥æ˜¯å¦ç‚ºå–æ¶ˆé¸æ“‡ï¼ˆé»æ“Šå·²é¸ä¸­çš„å¡ç‰‡ï¼‰
            if (currentFilter === type && type !== 'all') {
                // å–æ¶ˆé¸æ“‡ï¼Œå›åˆ°å…¨éƒ¨è¨­æ–½
                type = 'all';
            }
            
            currentFilter = type;
            
            if (type === 'all') {
                filteredFacilities = [...allFacilities];
            } else {
                // è™•ç†å–æ°´ç«™çš„å¤šç¨®é¡å‹
                if (type === 'å–æ°´ç«™') {
                    filteredFacilities = allFacilities.filter(f => 
                        f.type === 'å–æ°´ç«™' || f.type === 'è‡ªä¾†æ°´å…¬å¸çš„å–æ°´ç«™'
                    );
                } else if (type === 'ç½å€é†«ç™‚ç«™') {
                    filteredFacilities = allFacilities.filter(f => 
                        f.type === 'ç½å€é†«ç™‚ç«™' || f.type === 'ç½é›£é†«ç™‚ç«™'
                    );
                } else {
                    filteredFacilities = allFacilities.filter(f => f.type === type);
                }
            }
            
            updateDashboard();
            updateMap();
            updateTable();
            updateCardSelection(type);
            updateMapFilterSelection(type); // åŒæ­¥æ›´æ–°åœ°åœ–ç¯©é¸æŒ‰éˆ•
            updateTableFilterSelection(type); // åŒæ­¥æ›´æ–°è¡¨æ ¼ä¸‹æ‹‰é¸å–®
        }

        // åœ°åœ–ç¯©é¸åŠŸèƒ½ï¼ˆå¾åœ°åœ–æŒ‰éˆ•è§¸ç™¼ï¼‰
        function filterFacilitiesFromMap(type) {
            // æª¢æŸ¥æ˜¯å¦ç‚ºå–æ¶ˆé¸æ“‡ï¼ˆé»æ“Šå·²é¸ä¸­çš„æŒ‰éˆ•ï¼‰
            if (currentFilter === type && type !== 'all') {
                // å–æ¶ˆé¸æ“‡ï¼Œå›åˆ°å…¨éƒ¨è¨­æ–½
                type = 'all';
            }
            
            currentFilter = type;
            
            if (type === 'all') {
                filteredFacilities = [...allFacilities];
            } else {
                // è™•ç†å–æ°´ç«™çš„å¤šç¨®é¡å‹
                if (type === 'å–æ°´ç«™') {
                    filteredFacilities = allFacilities.filter(f => 
                        f.type === 'å–æ°´ç«™' || f.type === 'è‡ªä¾†æ°´å…¬å¸çš„å–æ°´ç«™'
                    );
                } else if (type === 'ç½å€é†«ç™‚ç«™') {
                    filteredFacilities = allFacilities.filter(f => 
                        f.type === 'ç½å€é†«ç™‚ç«™' || f.type === 'ç½é›£é†«ç™‚ç«™'
                    );
                } else {
                    filteredFacilities = allFacilities.filter(f => f.type === type);
                }
            }
            
            // æ›´æ–°ç•Œé¢
            updateDashboard();
            updateMap();
            updateTable();
            updateCardSelection(type);
            updateMapFilterSelection(type);
            updateTableFilterSelection(type); // åŒæ­¥æ›´æ–°è¡¨æ ¼ä¸‹æ‹‰é¸å–®
        }

        // æ›´æ–°åœ°åœ–ç¯©é¸æŒ‰éˆ•é¸ä¸­ç‹€æ…‹
        function updateMapFilterSelection(selectedType) {
            // æ¸…é™¤æ‰€æœ‰åœ°åœ–ç¯©é¸æŒ‰éˆ•çš„é¸ä¸­ç‹€æ…‹
            document.querySelectorAll('.map-filter-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // è¨­ç½®å°æ‡‰æŒ‰éˆ•ç‚ºé¸ä¸­ç‹€æ…‹
            const buttonMap = {
                'all': 'map-filter-all',
                'æµå‹•å»æ‰€': 'map-filter-toilets',
                'æ²æµ´ç«™': 'map-filter-showers',
                'å–æ°´ç«™': 'map-filter-water',
                'ç½å€é†«ç™‚ç«™': 'map-filter-medical'
            };
            
            const buttonId = buttonMap[selectedType];
            if (buttonId) {
                document.getElementById(buttonId).classList.add('active');
            }
        }

        // æ›´æ–°å¡ç‰‡é¸ä¸­ç‹€æ…‹
        function updateCardSelection(selectedType) {
            // æ¸…é™¤æ‰€æœ‰é¸ä¸­ç‹€æ…‹
            document.querySelectorAll('.dashboard-card').forEach(card => {
                card.classList.remove('selected', 'toilets', 'showers', 'water', 'medical');
            });
            
            // æ·»åŠ é¸ä¸­ç‹€æ…‹
            if (selectedType !== 'all') {
                const cardMap = {
                    'æµå‹•å»æ‰€': 'card-toilets',
                    'æ²æµ´ç«™': 'card-showers', 
                    'å–æ°´ç«™': 'card-water',
                    'ç½å€é†«ç™‚ç«™': 'card-medical'
                };
                
                const cardId = cardMap[selectedType];
                if (cardId) {
                    const card = document.getElementById(cardId);
                    card.classList.add('selected');
                    
                    // æ·»åŠ å°æ‡‰çš„æ¨£å¼é¡
                    if (selectedType === 'æµå‹•å»æ‰€') card.classList.add('toilets');
                    else if (selectedType === 'æ²æµ´ç«™') card.classList.add('showers');
                    else if (selectedType === 'å–æ°´ç«™') card.classList.add('water');
                    else if (selectedType === 'ç½å€é†«ç™‚ç«™') card.classList.add('medical');
                }
            }
        }

        // æœç´¢åŠŸèƒ½
        async function searchFacilities(query) {
            if (!query.trim()) {
                document.getElementById('search-results').classList.add('hidden');
                return;
            }
            
            try {
                // é¡¯ç¤ºæœç´¢è¼‰å…¥ç‹€æ…‹
                const resultsDiv = document.getElementById('search-results');
                const resultsList = document.getElementById('search-results-list');
                
                resultsList.innerHTML = `
                    <div class="flex items-center p-3 text-gray-600">
                        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-2"></div>
                        æ­£åœ¨æœç´¢ "${query}"...
                    </div>
                `;
                resultsDiv.classList.remove('hidden');
                
                const data = await callAPI('search', { q: query });
                const results = data.data || [];
                
                displaySearchResults(results, query);
                
            } catch (error) {
                console.error('æœç´¢å¤±æ•—:', error);
                displaySearchResults([], query);
            }
        }

        // é¡¯ç¤ºæœç´¢çµæœ
        function displaySearchResults(results, query) {
            const resultsDiv = document.getElementById('search-results');
            const resultsList = document.getElementById('search-results-list');
            
            if (results.length === 0) {
                resultsList.innerHTML = `<div class="text-gray-500 text-sm">æ²’æœ‰æ‰¾åˆ°åŒ…å« "${query}" çš„è¨­æ–½</div>`;
            } else {
                resultsList.innerHTML = results.map(facility => {
                    const config = facilityConfig[facility.type] || facilityConfig['æœªåˆ†é¡'];
                    return `
                        <div class="flex items-center p-2 hover:bg-gray-100 rounded cursor-pointer" 
                             onclick="focusOnSearchResult(${facility.lat}, ${facility.lng}, '${facility.name}')">
                            <i class="${config.icon} mr-2" style="color: ${config.color};"></i>
                            <div>
                                <div class="font-medium">${facility.name}</div>
                                <div class="text-xs text-gray-500">${facility.type} - ${facility.address || 'åº§æ¨™: ' + facility.lat.toFixed(4) + ', ' + facility.lng.toFixed(4)}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            resultsDiv.classList.remove('hidden');
        }

        // èšç„¦åˆ°æœç´¢çµæœ
        function focusOnSearchResult(lat, lng, name) {
            map.setView([lat, lng], 16);
            
            // æ‰¾åˆ°å°æ‡‰çš„æ¨™è¨˜ä¸¦æ‰“é–‹å½ˆçª—
            markersLayer.eachLayer(layer => {
                if (layer.getLatLng().lat === lat && layer.getLatLng().lng === lng) {
                    layer.openPopup();
                }
            });
            
            // éš±è—æœç´¢çµæœ
            document.getElementById('search-results').classList.add('hidden');
            document.getElementById('search-input').value = '';
        }

        // ç”¨æˆ¶å®šä½
        function locateUser() {
            if (!navigator.geolocation) {
                alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æŒå®šä½åŠŸèƒ½');
                return;
            }
            
            // é¡¯ç¤ºå®šä½è¼‰å…¥å‹•ç•«
            showMainLoading(true);
            updateProgress(0);
            updateLoadingText('æ­£åœ¨ç²å–æ‚¨çš„ä½ç½®...');
            
            navigator.geolocation.getCurrentPosition(
                async position => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    updateProgress(40);
                    updateLoadingText('ä½ç½®ç²å–æˆåŠŸï¼Œæ­£åœ¨è¼‰å…¥åœ°åœ–...');
                    await new Promise(resolve => setTimeout(resolve, 300));
                    
                    // ç§»é™¤èˆŠçš„ç”¨æˆ¶æ¨™è¨˜
                    if (userMarker) {
                        map.removeLayer(userMarker);
                    }
                    
                    updateProgress(60);
                    
                    // æ·»åŠ ç”¨æˆ¶ä½ç½®æ¨™è¨˜
                    userMarker = L.marker([lat, lng], {
                        icon: L.divIcon({
                            className: 'user-location-marker',
                            html: `<div style="
                                background-color: #3b82f6;
                                width: 16px;
                                height: 16px;
                                border-radius: 50%;
                                border: 3px solid white;
                                box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
                                animation: pulse 2s infinite;
                            "></div>`,
                            iconSize: [22, 22],
                            iconAnchor: [11, 11]
                        })
                    }).addTo(map);
                    
                    map.setView([lat, lng], 14);
                    updateProgress(80);
                    
                    updateLoadingText('æ­£åœ¨æœç´¢é™„è¿‘è¨­æ–½...');
                    
                    // æŸ¥æ‰¾é™„è¿‘è¨­æ–½
                    await findNearbyFacilities(lat, lng);
                    updateProgress(100);
                    
                    await new Promise(resolve => setTimeout(resolve, 300));
                    showMainLoading(false);
                },
                error => {
                    console.error('å®šä½éŒ¯èª¤:', error);
                    updateProgress(0);
                    showMainLoading(false);
                    
                    let errorMessage = 'å®šä½å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨å®šä½æ¬Šé™è¨­å®š';
                    if (error.code === 1) {
                        errorMessage = 'å®šä½æ¬Šé™è¢«æ‹’çµ•ï¼Œè«‹åœ¨ç€è¦½å™¨è¨­å®šä¸­å…è¨±å®šä½æ¬Šé™';
                    } else if (error.code === 2) {
                        errorMessage = 'ç„¡æ³•ç²å–ä½ç½®è³‡è¨Šï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥';
                    } else if (error.code === 3) {
                        errorMessage = 'å®šä½è«‹æ±‚è¶…æ™‚ï¼Œè«‹é‡è©¦';
                    }
                    
                    alert(errorMessage);
                }
            );
        }

        // æŸ¥æ‰¾é™„è¿‘è¨­æ–½
        async function findNearbyFacilities(lat, lng, radius = 5) {
            try {
                const data = await callAPI('nearby', { lat, lng, radius });
                const nearbyFacilities = data.data || [];
                
                if (nearbyFacilities.length > 0) {
                    alert(`åœ¨æ‚¨é™„è¿‘ ${radius} å…¬é‡Œå…§æ‰¾åˆ° ${nearbyFacilities.length} å€‹è¨­æ–½`);
                    
                    // æ›´æ–°é¡¯ç¤ºç‚ºé™„è¿‘è¨­æ–½
                    filteredFacilities = nearbyFacilities;
                    updateDashboard();
                    updateMap();
                    updateTable();
                    
                    // æ¸…é™¤å¡ç‰‡é¸ä¸­ç‹€æ…‹
                    updateCardSelection('all');
                } else {
                    alert(`åœ¨æ‚¨é™„è¿‘ ${radius} å…¬é‡Œå…§æ²’æœ‰æ‰¾åˆ°è¨­æ–½`);
                }
                
            } catch (error) {
                console.error('æŸ¥æ‰¾é™„è¿‘è¨­æ–½å¤±æ•—:', error);
            }
        }

        // è¨­ç½®äº‹ä»¶ç›£è½å™¨
        function setupEventListeners() {
            // å„€è¡¨æ¿å¡ç‰‡é»æ“Š
            document.getElementById('card-toilets').addEventListener('click', () => filterFacilities('æµå‹•å»æ‰€'));
            document.getElementById('card-showers').addEventListener('click', () => filterFacilities('æ²æµ´ç«™'));
            document.getElementById('card-water').addEventListener('click', () => filterFacilities('å–æ°´ç«™'));
            document.getElementById('card-medical').addEventListener('click', () => filterFacilities('ç½å€é†«ç™‚ç«™'));
            
            // åœ°åœ–æ§åˆ¶æŒ‰éˆ•
            document.getElementById('locate-user').addEventListener('click', locateUser);
            document.getElementById('zoom-in').addEventListener('click', () => map.zoomIn());
            document.getElementById('zoom-out').addEventListener('click', () => map.zoomOut());
            
            // æœç´¢åŠŸèƒ½
            const searchInput = document.getElementById('search-input');
            let searchTimeout;
            
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    searchFacilities(e.target.value);
                }, 300);
            });
            
            document.getElementById('clear-search').addEventListener('click', () => {
                searchInput.value = '';
                document.getElementById('search-results').classList.add('hidden');
            });
            
            // è¡¨æ ¼ç¯©é¸åŒæ­¥åŠŸèƒ½
            document.getElementById('table-filter').addEventListener('change', (e) => {
                const filterValue = e.target.value;
                // ä¸è¦é‡è¤‡èª¿ç”¨filterFacilitiesï¼Œè€Œæ˜¯ç›´æ¥èª¿ç”¨åœ°åœ–ç¯©é¸åŠŸèƒ½
                filterFacilitiesFromMap(filterValue === 'all' ? 'all' : filterValue);
            });
        }

        // åœ°åœ–ç¯©é¸é¢æ¿å±•é–‹/æ”¶åˆåŠŸèƒ½
        function toggleMapFilter() {
            const control = document.getElementById('map-filter-control');
            control.classList.toggle('collapsed');
            
            // å„²å­˜å±•é–‹/æ”¶åˆç‹€æ…‹åˆ° localStorage
            const isCollapsed = control.classList.contains('collapsed');
            localStorage.setItem('mapFilterCollapsed', isCollapsed);
        }

        // åˆå§‹åŒ–åœ°åœ–ç¯©é¸é¢æ¿ç‹€æ…‹
        function initMapFilterState() {
            const isCollapsed = localStorage.getItem('mapFilterCollapsed') === 'true';
            if (isCollapsed) {
                document.getElementById('map-filter-control').classList.add('collapsed');
            }
        }

        // è¡¨æ ¼å±•é–‹/æ”¶åˆåŠŸèƒ½
        function toggleTable() {
            const tableContent = document.getElementById('table-content');
            const tableControls = document.getElementById('table-controls');
            const toggleIcon = document.getElementById('toggle-icon');
            const tableStatus = document.getElementById('table-status');
            
            const isHidden = tableContent.classList.contains('hidden');
            
            if (isHidden) {
                // å±•é–‹
                tableContent.classList.remove('hidden');
                tableControls.classList.remove('hidden');
                toggleIcon.classList.add('rotate-180');
                tableStatus.textContent = 'å·²å±•é–‹';
            } else {
                // æ”¶åˆ
                tableContent.classList.add('hidden');
                tableControls.classList.add('hidden');
                toggleIcon.classList.remove('rotate-180');
                tableStatus.textContent = 'å·²æ”¶åˆ';
            }
            
            // å„²å­˜ç‹€æ…‹åˆ° localStorage
            localStorage.setItem('tableExpanded', isHidden);
        }

        // åˆå§‹åŒ–è¡¨æ ¼ç‹€æ…‹
        function initTableState() {
            const isExpanded = localStorage.getItem('tableExpanded') === 'true';
            if (isExpanded) {
                toggleTable(); // å¦‚æœä¹‹å‰æ˜¯å±•é–‹çš„ï¼Œå‰‡å±•é–‹
            }
        }

        // æ›´æ–°è¡¨æ ¼ç¯©é¸ä¸‹æ‹‰é¸å–®é¸ä¸­ç‹€æ…‹
        function updateTableFilterSelection(selectedType) {
            const tableFilter = document.getElementById('table-filter');
            
            // è¨­ç½®ä¸‹æ‹‰é¸å–®çš„å€¼
            if (selectedType === 'all') {
                tableFilter.value = 'all';
            } else {
                tableFilter.value = selectedType;
            }
        }

        // å…¨å±€å‡½æ•¸ä¾› HTML ä½¿ç”¨
        window.focusOnFacility = focusOnFacility;
        window.focusOnSearchResult = focusOnSearchResult;
        window.toggleMapFilter = toggleMapFilter;
        window.toggleTable = toggleTable;
    </script>
</body>
</html>